{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'voting/css/main_dashboard.css' %}">
{% endblock %}

{% block content %}
<h1 class="mb-8">Panel de Visitantes</h1>
<p class="muted mt-0">Buscá votantes por DNI y monitoreá el avance por zona.</p>

<!-- Search Bar -->
<div class="search-row card row p-10">
    <input type="text" id="search-dni" placeholder="DNI" inputmode="numeric" pattern="[0-9]*" class="w-100 max-w-220">
    <button id="send-button" class="btn btn-success">Enviar</button>
    <button id="search-button" class="btn btn-primary">Buscar</button>
    <div id="fast-feedback" class="inline-feedback hidden"></div>
    </div>

<!-- Voter Details Area directly under search (messages appear here) -->
<div id="voter-details" class="mt-12">
    <!-- Search / send results will be displayed here -->
    <div id="voter-skeleton" class="skeleton skeleton-card hidden"></div>
    </div>

<div class="card mt-16 p-10">
    <button id="show-progress" class="btn">Mostrar progreso</button>
    <div id="zone-block" class="zone-filter-block mt-12" style="display:none;">
    <label for="zone-select"><strong>Zonas:</strong></label>
    <select id="zone-select" style="min-width:220px;"></select>
    <span class="zone-progress-summary" style="margin-left:12px; font-weight:600; font-size:.9rem; display:none;">0/0 (0%)</span>
    <div class="zone-progress-bar-wrapper" style="margin-top:6px; max-width:420px; display:none;">
        <div class="zone-bar">
            <div class="zone-fill" style="width:0;"></div>
        </div>
    </div>
    <div id="zone-skel" class="skeleton skeleton-bar hidden mt-6" style="max-width:420px;"></div>
    <div class="pending-actions mt-16">
        <div class="row">
            <button id="load-pending-button" class="btn btn-purple">Lista de pendientes</button>
            <button id="refresh-button" class="btn btn-success">Actualizar</button>
        </div>
        <button id="load-more-pending" class="btn" style="display:none;">Cargar más</button>
    </div>
    <div id="pending-meta" class="muted mt-6" style="font-size:.85rem; display:none;"></div>
    <div id="pending-list" class="pending-list mt-8" style="display:none;"></div>
    </div>
</div>

<!-- (Removed duplicate voter-details block) -->

<hr>

<script>
$(document).ready(function () {
    const TEXTS = {
        enter_dni: 'Por favor ingrese un DNI para buscar.',
    voted: 'Votó',
    not_voted: 'No votó',
        unmark: 'Desmarcar como Votado',
        mark_voted: 'Marcar como Votado',
        name: 'Nombre',
        dni: 'DNI',
        status: 'Estado',
        no_voter_found: 'No se encontró un votante con ese DNI.',
        error_occurred: 'Ocurrió un error al buscar.'
    };

    function initializePage(texts) {
        console.log("Visitor Dashboard Initialized.");

        function getCSRFToken() {
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            return tokenElement ? tokenElement.value : null;
        }

        const voterSkeleton = document.getElementById('voter-skeleton');
        const fastFeedback = document.getElementById('fast-feedback');
        function showFastFeedback(text){
            if (!fastFeedback) return;
            fastFeedback.textContent = text;
            fastFeedback.classList.remove('hidden');
            setTimeout(()=>fastFeedback.classList.add('hidden'), 1500);
        }
        function sendMark(){
            var dni = $("#search-dni").val().trim();
            if (!dni) { return; }
            // Clear Django message banners on interaction
            $(".messages").remove();
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) { return; }
            $.ajax({
                url: "{% url 'voting:mark_by_dni_set' %}",
                type: "POST",
                headers: { "X-CSRFToken": csrfToken },
                data: { dni: dni },
                success: function(resp){
                    if (resp.status === 'success') {
                        // Show a green success box below, similar to search no-match
                        $("#voter-details").html(`<p class="success-message">${dni} enviado</p>`);
                        showFastFeedback('Marcado como Votó');
                    }
                    else {
                        $("#voter-details").html(`<p class="error-message">${resp.message || 'Error'}</p>`);
                        showFastFeedback(resp.message || 'Error');
                    }
                },
                error: function(){ showFastFeedback('Error de red'); }
            });
        }
        function triggerSearch(){
            var dni = $("#search-dni").val().trim();
                if (!dni) { return; }
            // Clear Django message banners on interaction
            $(".messages").remove();
            if (voterSkeleton) voterSkeleton.classList.remove('hidden');
            $("#voter-details").empty();

            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? texts.voted : texts.not_voted;
                        const actionButtonText = voter.voted ? texts.unmark : texts.mark_voted;
                        const statusClass = voter.voted ? 'ok' : 'bad';
                        const voterHtml = `
                            <div class="voter-box ${statusClass}">
                                <p><strong>${texts.name}:</strong> ${voter.name}</p>
                                <p><strong>${texts.dni}:</strong> ${voter.dni}</p>
                                <p><strong>Zona:</strong> ${voter.zone || 'Sin asignar'}</p>
                                <p><strong>${texts.status}:</strong> <span class="status-badge ${statusClass} voted-status mark-voted" data-voter-id="${voter.id}" data-voted="${voter.voted}" title="Cambiar estado">${votedStatusText}</span></p>
                            </div>`;
                        $("#voter-details").html(voterHtml);
                    } else if (response.status === "no_data") {
                        $("#voter-details").html(`<p class="error-message">Sin datos, por favor cargue una lista de votantes primero</p>`);
                    } else if (response.status === "not_found") {
                        $("#voter-details").html(`<p class="error-message">${texts.no_voter_found}</p>`);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    }
                    if (voterSkeleton) voterSkeleton.classList.add('hidden');
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    if (voterSkeleton) voterSkeleton.classList.add('hidden');
                }
            });
        }

    $("#search-button").on("click", triggerSearch);
    $("#send-button").on("click", sendMark);
    $("#search-dni").on("keyup", function(e){ if (e.key === 'Enter') { sendMark(); } });

        // Event delegation for marking a voter
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            // Clear Django message banners on interaction
            $(".messages").remove();
            var voterId = $(this).data("voter-id");
            var button = $(this);
            var csrfToken = getCSRFToken();

            if (!csrfToken) { return; }

            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": csrfToken },
                success: function (response) {
                    if (response.status === "success") {
                        var container = button.closest('.voter-box');
                        var statusSpan = container.find('.voted-status');
                        // Use server authoritative value
                        var newVoted = response.voted === true;
                        statusSpan.text(newVoted ? texts.voted : texts.not_voted)
                            .toggleClass('ok', newVoted)
                            .toggleClass('bad', !newVoted)
                            .attr('data-voted', newVoted);
                        container.toggleClass('ok', newVoted).toggleClass('bad', !newVoted);
                        if (typeof refreshAll === 'function') {
                            refreshAll({ preservePending:true });
                        }
                    } else {
                        alert(response.message || texts.error_occurred);
                    }
                },
                error: function () {
                    alert(texts.error_occurred);
                }
            });
        });

        // --- Zone + pending logic ---
        const zoneSelect = document.getElementById('zone-select');
        const zoneSummary = document.querySelector('.zone-progress-summary');
        const zoneBarWrapper = document.querySelector('.zone-progress-bar-wrapper');
        const zoneFill = zoneBarWrapper.querySelector('.zone-fill');
        const pendingButton = document.getElementById('load-pending-button');
        const loadMoreButton = document.getElementById('load-more-pending');
        const pendingList = document.getElementById('pending-list');
        const pendingMeta = document.getElementById('pending-meta');
        let zonesCache = [];
        let pendingPage = 0;
        let pendingHasMore = false;
        let currentZoneId = 'all';
        const PAGE_SIZE = 100;

        function fetchZones(cb) {
            const zsk = document.getElementById('zone-skel');
            if (zsk) zsk.classList.remove('hidden');
            $.get('{% url "voting:get_zone_stats" %}', function(resp){
                if (resp.status !== 'success') { console.warn('Fallo carga zonas'); if(cb) cb(); return; }
                zonesCache = resp.zones || [];
                buildZoneSelect();
                if (cb) cb();
            }).fail(function(){ console.error('Error HTTP zonas'); if(cb) cb(); })
            .always(function(){ if (zsk) zsk.classList.add('hidden'); });
    }
        function buildZoneSelect() {
            zoneSelect.innerHTML = '';
            const optAll = document.createElement('option');
            optAll.value = 'all';
            optAll.textContent = 'Todas';
            zoneSelect.appendChild(optAll);
            zonesCache.forEach(z => {
                const o = document.createElement('option');
                o.value = z.id;
                o.textContent = `${z.name}`;
                zoneSelect.appendChild(o);
            });
            // Trigger initial update
            updateZoneProgress();
        }
        function updateZoneProgress() {
            const selected = zoneSelect.value;
            currentZoneId = selected;
            if (selected === 'all') {
                // Aggregate overall from zones
                let total = 0, voted = 0;
                zonesCache.forEach(z => { total += z.total_voters; voted += z.voted_count; });
                const pct = total > 0 ? (voted/total*100).toFixed(2) : 0;
                zoneSummary.textContent = `${voted}/${total} (${pct}%)`;
                zoneFill.style.width = `${pct}%`;
            } else {
                const z = zonesCache.find(z => String(z.id) === selected);
                if (z) {
                    zoneSummary.textContent = `${z.voted_count}/${z.total_voters} (${z.percentage}%)`;
                    zoneFill.style.width = `${z.percentage}%`;
                }
            }
            if (zonesCache.length === 0) {
                zoneSummary.style.display = 'none';
                zoneBarWrapper.style.display = 'none';
            } else {
                zoneSummary.style.display = 'inline-block';
                zoneBarWrapper.style.display = 'block';
            }
            // Do not clear pending automatically here
        }
        function clearPending() {
            pendingPage = 0;
            pendingList.innerHTML = '';
            pendingList.style.display = 'none';
            pendingMeta.style.display = 'none';
            loadMoreButton.style.display = 'none';
        }
        function refreshAll(opts={}) {
            const { preservePending=false } = opts;
            const showing = pendingList.style.display === 'block';
            const previous = currentZoneId;
            fetchZones(function(){
                if ([...zoneSelect.options].some(o => o.value === previous)) {
                    zoneSelect.value = previous;
                }
                updateZoneProgress();
                if (preservePending && showing) {
                    pendingList.innerHTML='';
                    loadPending(1);
                } else if (!preservePending) {
                    clearPending();
                }
            });
        }
        function loadPending(nextPage) {
            $.get('{% url "voting:pending_voters" %}', { zone_id: currentZoneId, page: nextPage, page_size: PAGE_SIZE }, function(resp){
                if (resp.status !== 'success') return;
                pendingPage = resp.page;
                pendingHasMore = resp.has_more;
                renderPending(resp.voters, resp.total);
            });
        }
        function renderPending(voters, total) {
            if (voters.length > 0) {
                pendingList.style.display = 'block';
            }
            const frag = document.createDocumentFragment();
            voters.forEach(v => {
                const div = document.createElement('div');
                div.className = 'pending-item';
                div.textContent = `${v.dni} - ${v.name}`;
                frag.appendChild(div);
            });
            pendingList.appendChild(frag);
            pendingMeta.style.display = 'block';
            const shown = pendingList.children.length;
            const pct = total > 0 ? ((shown/total)*100).toFixed(1) : 0;
            pendingMeta.textContent = `Mostrando ${shown} de ${total} pendientes (${pct}%)`;
            if (pendingHasMore) {
                loadMoreButton.style.display = 'inline-block';
            } else {
                loadMoreButton.style.display = 'none';
            }
        }
        function clearSearchBox(){
            $('#search-dni').val('');
            $('#voter-details').empty();
        }
        zoneSelect.addEventListener('change', function(){
            updateZoneProgress();
            clearPending();
            clearSearchBox();
        });
        pendingButton.addEventListener('click', function(){
            clearPending();
            clearSearchBox();
            loadPending(1);
        });
        loadMoreButton.addEventListener('click', function(){
            if (pendingHasMore) loadPending(pendingPage + 1);
        });

        // Bind refresh button
        const refreshBtn = document.getElementById('refresh-button');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function(){
                clearSearchBox();
                refreshAll({ preservePending:true });
            });
        }
        // Lazy-load zone block
        const showProgressBtn = document.getElementById('show-progress');
        const zoneBlock = document.getElementById('zone-block');
        if (showProgressBtn && zoneBlock) {
            showProgressBtn.addEventListener('click', function(){
                showProgressBtn.disabled = true;
                zoneBlock.style.display = 'block';
                fetchZones();
            });
        }
        // end zone logic
    }
    // Initialize page behavior now that TEXTS is defined
    initializePage(TEXTS);
});
</script>
{% endblock %}
