{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'css/main_dashboard.css' %}">
{% endblock %}

{% block content %}
<h1>{% trans "Welcome to the Visitor Dashboard" %}</h1>

<hr>

<!-- Search Bar -->
<input type="text" id="search-dni" placeholder="{% trans 'Search by DNI' %}">
<button id="search-button">{% trans "Search" %}</button>

<!-- Voter Details Area -->
<div id="voter-details" style="margin-top: 20px;">
    <!-- Search results will be displayed here -->
</div>

<hr>

<script>
    let translations = {};

    $(document).ready(function () {
        // Fetch translations first
        $.ajax({
            url: "{% url 'voting:get_translations' %}",
            async: false, // Ensure translations are loaded before other scripts run
            success: function(data) {
                translations = data;
            },
            error: function() {
                console.error("Failed to load translations.");
            }
        });

        console.log("Visitor Dashboard Document is ready."); // Debugging log

        // CSRF token setup for AJAX (Needed if mark_voted is used by visitors)
        function getCSRFToken() {
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            return tokenElement ? tokenElement.value : null;
        }

        // AJAX: Search voter by DNI
        $("#search-button").on("click", function () {
            console.log("Search button clicked (Visitor)."); // Debugging log
            var dni = $("#search-dni").val().trim();
            console.log("Search DNI (Visitor):", dni); // Debugging log

            if (!dni) {
                $("#voter-details").html(`<p class="error-message">${translations.enter_dni || 'Please enter a DNI to search.'}</p>`);
                return;
            }

            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? translations.voted : translations.not_voted;
                        const actionButtonText = voter.voted ? translations.unmark : translations.mark_voted;
                        const voterHtml = `
                            <p><strong>${translations.name}</strong> ${voter.name}</p>
                            <p><strong>${translations.dni}</strong> ${voter.dni}</p>
                            <p><strong>${translations.status}</strong> <span class="voted-status">${votedStatusText}</span></p>
                            <p><a href="#" class="mark-voted" data-voter-id="${voter.id}">${actionButtonText}</a></p>
                        `;
                        $("#voter-details").html(voterHtml);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${translations.no_voter_found}</p>`);
                    }
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${translations.no_voter_found}</p>`);
                }
            });
        });

        // AJAX: Mark voter as voted functionality
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            console.log("Mark voted clicked (Visitor)."); // Debugging log
            var voterId = $(this).data("voter-id");
            var button = $(this);
            var csrfToken = getCSRFToken();

            if (!csrfToken) {
                alert(translations.error_occurred || 'Action requires login or CSRF token.');
                return;
            }

            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": csrfToken },
                success: function (response) {
                    console.log("Mark Voted AJAX success response (Visitor):", response);
                    if (response.status === "success") {
                        var statusSpan = button.closest("#voter-details").find(".voted-status");
                        if (statusSpan.text() === translations.voted) {
                            statusSpan.text(translations.not_voted);
                            button.text(translations.mark_voted);
                        } else {
                            statusSpan.text(translations.voted);
                            button.text(translations.unmark);
                        }
                    } else {
                        alert(response.message || translations.error_occurred);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Mark Voted AJAX error (Visitor):", status, error);
                    alert(translations.error_occurred);
                }
            });
        });
    });
</script>
{% endblock %}
