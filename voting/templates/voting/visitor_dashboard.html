{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'voting/css/main_dashboard.css' %}">
{% endblock %}

{% block content %}
<h1>Bienvenido al Panel de Visitantes</h1>

<hr>

<!-- Search Bar -->
<input type="text" id="search-dni" placeholder="Buscar por DNI">
<button id="search-button" class="btn btn-primary">Buscar</button>

<!-- Voter Details Area -->
<div id="voter-details" style="margin-top: 20px;">
    <!-- Search results will be displayed here -->
</div>

<hr>

<script>
$(document).ready(function () {
    const TEXTS = {
        enter_dni: 'Por favor ingrese un DNI para buscar.',
        voted: 'Ha votado',
        not_voted: 'No ha votado',
        unmark: 'Desmarcar como Votado',
        mark_voted: 'Marcar como Votado',
        name: 'Nombre',
        dni: 'DNI',
        status: 'Estado',
        no_voter_found: 'No se encontró un votante con ese DNI.',
        error_occurred: 'Ocurrió un error al buscar.'
    };

    function initializePage(texts) {
        console.log("Visitor Dashboard Initialized.");

        function getCSRFToken() {
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            return tokenElement ? tokenElement.value : null;
        }

        $("#search-button").on("click", function () {
            var dni = $("#search-dni").val().trim();
                if (!dni) { return; }
            // Clear Django message banners on interaction
            $(".messages").remove();

            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? texts.voted : texts.not_voted;
                        const actionButtonText = voter.voted ? texts.unmark : texts.mark_voted;
                        const statusClass = voter.voted ? 'ok' : 'bad';
                        const voterHtml = `
                            <div class="voter-box ${statusClass}">
                                <p><strong>${texts.name}:</strong> ${voter.name}</p>
                                <p><strong>${texts.dni}:</strong> ${voter.dni}</p>
                                <p><strong>${texts.status}:</strong> <span class="status-badge ${statusClass} voted-status">${votedStatusText}</span></p>
                                <p><a href="#" class="mark-voted" data-voter-id="${voter.id}">${actionButtonText}</a></p>
                            </div>`;
                        $("#voter-details").html(voterHtml);
                    } else if (response.status === "no_data") {
                        $("#voter-details").html(`<p class="error-message">Sin datos, por favor cargue una lista de votantes primero</p>`);
                    } else if (response.status === "not_found") {
                        $("#voter-details").html(`<p class="error-message">${texts.no_voter_found}</p>`);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    }
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                }
            });
        });

        // Event delegation for marking a voter
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            // Clear Django message banners on interaction
            $(".messages").remove();
            var voterId = $(this).data("voter-id");
            var button = $(this);
            var csrfToken = getCSRFToken();

            if (!csrfToken) { return; }

            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": csrfToken },
                success: function (response) {
                    if (response.status === "success") {
                        var container = button.closest('.voter-box');
                        var statusSpan = container.find('.voted-status');
                        var currentlyVoted = statusSpan.text() === texts.voted;
                        if (currentlyVoted) {
                            statusSpan.text(texts.not_voted)
                                .removeClass('ok').addClass('bad');
                            container.removeClass('ok').addClass('bad');
                            button.text(texts.mark_voted);
                        } else {
                            statusSpan.text(texts.voted)
                                .removeClass('bad').addClass('ok');
                            container.removeClass('bad').addClass('ok');
                            button.text(texts.unmark);
                        }
                    } else {
                        alert(response.message || texts.error_occurred);
                    }
                },
                error: function () {
                    alert(texts.error_occurred);
                }
            });
        });
    }
    // Initialize page behavior now that TEXTS is defined
    initializePage(TEXTS);
});
</script>
{% endblock %}
