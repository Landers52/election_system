{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'css/main_dashboard.css' %}">
{% endblock %}
{% block content %}
<h1>{% trans "Welcome to the Main Dashboard" %}</h1>

<!-- Progress Bar Section -->
<div class="progress-container">
    <h3>{% trans "Voting Progress" %}</h3>
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <div class="progress-stats">
        <span class="voted-count">{% trans "0 voted" %}</span>
        <span class="percentage">{% trans "0%" %}</span>
        <span class="total-voters">{% trans "0 total voters" %}</span>
    </div>
    <div class="no-voters-message" style="display: none;">
        {% trans "No voters have been registered yet. Please upload a voter list to begin." %}
    </div>
</div>

<!-- Voter Upload Form -->
{# Pass voter count via data attribute to avoid JS linter issues with Django tags #}
<form id="upload-form" method="post" enctype="multipart/form-data" data-voter-count="{{ voter_count|default:0 }}">
    {% csrf_token %}
    <input type="hidden" name="confirm_replace" id="confirm-replace" value="no"> {# Hidden field for confirmation #}
    <div class="custom-file-upload">
        <input type="file" name="file" id="file" class="file-input" required style="display: none;" accept=".xlsx"> {# Added accept attribute for Excel files #}
        <label for="file" class="file-label button-like-label">
            {% trans "Choose file" %} <span class="file-text">({% trans "No file selected" %})</span>
        </label>
    </div>
    <button type="submit" id="upload-button">{% trans "Upload Voter List" %}</button>
</form>

<!-- Confirmation Dialog (Initially Hidden) -->
<div id="confirmation-dialog" class="confirmation-dialog" style="display: none;">
    <p>{% trans "Voters already exist in the system. Do you want to replace them with the new list?" %}</p>
    <button id="confirm-replace-button">{% trans "Yes, Replace" %}</button>
    <button id="cancel-replace-button">{% trans "No, Cancel" %}</button>
</div>


<hr>

<!-- Search Bar -->
<input type="text" id="search-dni" placeholder="{% trans 'Search by DNI' %}">
<button id="search-button">{% trans "Search" %}</button>

<!-- Voter Details Area -->
<div id="voter-details" style="margin-top: 20px;">
    <!-- Search results will be displayed here -->
</div>

<hr>

<script>
const uploadForm = document.getElementById('upload-form');
// Read voter count from the form's data attribute
const initialVoterCount = parseInt(uploadForm.getAttribute('data-voter-count'), 10) || 0; 
const uploadButton = document.getElementById('upload-button');
const fileInput = document.getElementById('file');
const confirmationDialog = document.getElementById('confirmation-dialog');
const confirmReplaceButton = document.getElementById('confirm-replace-button');
const cancelReplaceButton = document.getElementById('cancel-replace-button');
const confirmReplaceInput = document.getElementById('confirm-replace');


fileInput.addEventListener('change', function(e) {
    const fileName = e.target.files[0]?.name;
    const fileTextSpan = document.querySelector('.file-text'); // Get the span
    if (fileName) {
        // Update the text content of the span
        fileTextSpan.textContent = `(${fileName})`; 
    } else {
        // Reset the text content of the span
        fileTextSpan.textContent = "({% trans 'No file selected' %})";
    }
});

uploadForm.addEventListener('submit', function(e) {
    // Prevent default submission initially
    e.preventDefault();

    // Check if a file is selected
    if (!fileInput.files || fileInput.files.length === 0) {
        alert("{% trans 'Please select a file to upload.' %}");
        return; // Stop if no file is selected
    }

    // Check if voters exist and confirmation is needed
    if (initialVoterCount > 0) {
        confirmationDialog.style.display = 'block'; // Show the dialog
    } else {
        // No existing voters, submit directly
        confirmReplaceInput.value = 'no'; // Ensure it's 'no'
        uploadForm.submit(); // Submit the form
    }
});

confirmReplaceButton.addEventListener('click', function() {
    confirmReplaceInput.value = 'yes'; // Set confirmation flag
    confirmationDialog.style.display = 'none'; // Hide dialog
    uploadForm.submit(); // Submit the form
});

cancelReplaceButton.addEventListener('click', function() {
    confirmReplaceInput.value = 'no'; // Ensure flag is 'no'
    confirmationDialog.style.display = 'none'; // Hide dialog
    // Do not submit the form
});


$(document).ready(function () {
    // CSRF token setup for AJAX (Keep existing AJAX logic)
    function getCSRFToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]').value;
        return token;
    }

    // AJAX: Search voter by DNI
    $("#search-button").on("click", function () {
        var dni = $("#search-dni").val().trim();

        if (!dni) {
            alert("{% trans 'Please enter a DNI to search.' %}");
            return;
        }

        $.ajax({
            url: "{% url 'voting:search_voter_by_dni' %}",
            type: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            data: { 'dni': dni },
            success: function (response) {
                $("#voter-details").empty();
                if (response.status === "success" && response.voter) {
                    const voter = response.voter;
                    const votedStatusText = voter.voted ? "{% trans 'Voted' %}" : "{% trans 'Not Voted' %}";
                    const actionButtonText = voter.voted ? "{% trans 'Unmark' %}" : "{% trans 'Mark Voted' %}";
                    const voterHtml = `
                        <p><strong>{% trans "Name:" %}</strong> ${voter.name}</p>
                        <p><strong>{% trans "DNI:" %}</strong> ${voter.dni}</p>
                        <p><strong>{% trans "Status:" %}</strong> <span class="voted-status">${votedStatusText}</span></p>
                        <p>
                            <a href="#" class="mark-voted" data-voter-id="${voter.id}">
                                ${actionButtonText}
                            </a>
                        </p>
                    `;
                    $("#voter-details").html(voterHtml);
                } else {
                    // Always show 'No voter found' for any non-success
                    $("#voter-details").html(`<p class="error-message">{% trans "No voter found with that ID" %}</p>`);
                }
            },
            error: function (xhr, status, error) {
                // Display generic error message in the details area, removed the alert
                $("#voter-details").html(`<p class="error-message">{% trans 'No voter found with that ID' %}</p>`);
            }
        });
    });

    // Function to update the progress bar
    function updateVoterStats() {
        $.ajax({
            url: "{% url 'voting:get_voter_stats' %}",
            type: "GET",
            success: function(response) {
                if (response.status === "success") {
                    const stats = response.stats;
                    if (stats.total_voters === 0) {
                        $('.progress-stats').hide();
                        $('.progress-bar').hide();
                        $('.no-voters-message').show();
                    } else {
                        $('.progress-stats').show();
                        $('.progress-bar').show();
                        $('.no-voters-message').hide();
                        
                        $('.progress-fill').css('width', `${stats.percentage}%`);
                        // Format strings with translations
                        $('.voted-count').text("{% blocktrans %}{{ n }} voted{% endblocktrans %}".replace('{{ n }}', stats.voted_count));
                        $('.percentage').text(`${stats.percentage}%`);
                        $('.total-voters').text("{% blocktrans %}{{ n }} total voters{% endblocktrans %}".replace('{{ n }}', stats.total_voters));
                    }
                }
            }
        });
    }

    // Update stats on page load
    updateVoterStats();

    // AJAX: Mark voter as voted (delegated event handler)
    $("#voter-details").on("click", ".mark-voted", function (e) {
        e.preventDefault();
        var voterId = $(this).data("voter-id");
        var button = $(this);

        $.ajax({
            url: "{% url 'voting:mark_voted' 0 %}".replace('0', voterId),
            type: "POST",
            headers: { "X-CSRFToken": getCSRFToken() },
            success: function (response) {
                if (response.status === "success") {
                    var statusSpan = button.closest("#voter-details").find(".voted-status");
                    const votedText = "{% trans 'Voted' %}";
                    const notVotedText = "{% trans 'Not Voted' %}";
                    const markVotedText = "{% trans 'Mark Voted' %}";
                    const unmarkText = "{% trans 'Unmark' %}";
                    
                    if (statusSpan.text() === votedText) {
                        statusSpan.text(notVotedText);
                        button.text(markVotedText);
                    } else {
                        statusSpan.text(votedText);
                        button.text(unmarkText);
                    }
                    updateVoterStats();
                } else {
                    alert(response.message || "{% trans 'An error occurred while updating status.' %}");
                }
            },
            error: function (xhr, status, error) {
                alert("{% trans 'An error occurred while processing the request.' %}");
            }
        });
    });
});
</script>
{% endblock %}
