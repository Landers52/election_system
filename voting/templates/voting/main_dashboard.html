{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'voting/css/main_dashboard.css' %}">
{% endblock %}
{% block content %}
<h1>Bienvenido al Panel Principal</h1>

<!-- Progress Bar Section -->
<div class="progress-container">
    <h3>Progreso de Votación</h3>
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <div class="progress-stats">
        <span class="voted-count">0 votados</span>
        <span class="percentage">0%</span>
        <span class="total-voters">0 votantes en total</span>
    </div>
    <div class="no-voters-message" style="display: none;">
        No se han registrado votantes aún. Por favor sube una lista de votantes para comenzar.
    </div>
    <div id="inline-feedback" class="inline-feedback" style="display:none;"></div>
</div>

<!-- Actions grid: left (upload), right (delete) -->
<div class="actions-grid">
    <div class="col">
        <!-- Voter Upload Form -->
        <form id="upload-form" method="post" enctype="multipart/form-data" data-voter-count="{{ voter_count|default:0 }}">
            {% csrf_token %}
            <input type="hidden" name="confirm_replace" id="confirm-replace" value="no">
            <div class="custom-file-upload">
                <input type="file" name="file" id="file" class="file-input" required style="display:none;" accept=".xlsx">
                <div class="file-actions-row">
                    <label for="file" class="file-label button-like-label">
                        Elegir archivo <span class="file-text">(Ningún archivo seleccionado)</span>
                    </label>
                    <button type="submit" id="upload-button" class="btn btn-primary">Subir lista</button>
                </div>
            </div>
        </form>
        <small class="hint">Formatos aceptados: .xlsx (Excel). La importación ignora filas sin DNI o Nombre.</small>
    </div>
    <div class="col">
        <div class="delete-box">
            <button id="clear-list-button" class="btn btn-soft-danger" type="button" disabled>Borrar lista</button>
            <small class="hint">Elimina todos los votantes cargados para tu cuenta. Esta acción no se puede deshacer.</small>
        </div>
    </div>
    
</div>

<!-- Confirmation Dialog (Initially Hidden) -->
<div id="confirmation-dialog" class="confirmation-dialog" style="display:none;">
    <p id="confirmation-message">Confirmar acción</p>
    <div class="dialog-buttons">
        <button id="confirm-action-button" class="btn btn-danger">Confirmar</button>
        <button id="cancel-action-button" class="btn">Cancelar</button>
    </div>
</div>


<hr>

<!-- Search Bar -->
<input type="text" id="search-dni" placeholder="Buscar por DNI">
<button id="search-button" class="btn btn-primary">Buscar</button>

<!-- Voter Details Area -->
<div id="voter-details" style="margin-top: 20px;">
    <!-- Search results will be displayed here -->
</div>

<hr>

<script>
$(document).ready(function () {
    // Spanish-only text constants
    const TEXTS = {
        please_select_file: 'Por favor seleccione un archivo para subir.',
        no_file_selected: 'Ningún archivo seleccionado',
        enter_dni: 'Por favor ingrese un DNI para buscar.',
        voted: 'Ha votado',
        not_voted: 'No ha votado',
        unmark: 'Desmarcar como Votado',
        mark_voted: 'Marcar como Votado',
        name: 'Nombre',
        dni: 'DNI',
        status: 'Estado',
        no_voter_found: 'No se encontró un votante con ese DNI.',
        error_occurred: 'Ocurrió un error al buscar.',
        n_voted: '{n} votados',
        n_total_voters: '{n} votantes en total'
    };

    function initializePage(texts) {
        const uploadForm = document.getElementById('upload-form');
        // Dynamic voter count that can be refreshed after actions
        let currentVoterCount = parseInt(uploadForm.getAttribute('data-voter-count'), 10) || 0;
        const fileInput = document.getElementById('file');
        const confirmationDialog = document.getElementById('confirmation-dialog');
        const confirmActionButton = document.getElementById('confirm-action-button');
        const cancelActionButton = document.getElementById('cancel-action-button');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmReplaceInput = document.getElementById('confirm-replace');
    const clearListButton = document.getElementById('clear-list-button');
        const inlineFeedback = document.getElementById('inline-feedback');
        let pendingAction = null; // 'replace' | 'delete'

        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            const fileTextSpan = document.querySelector('.file-text');
            if (fileName) {
                fileTextSpan.textContent = `(${fileName})`;
            } else {
                fileTextSpan.textContent = `(${texts.no_file_selected})`;
            }
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!fileInput.files || fileInput.files.length === 0) {
                alert(texts.please_select_file);
                return;
            }
            // Clear Django message banners on interaction
            $(".messages").remove();
            // Show confirmation only if there are existing voters
            if (currentVoterCount > 0) {
                pendingAction = 'replace';
                confirmationMessage.textContent = 'Ya existe una lista cargada. ¿Deseas reemplazarla con la nueva?';
                confirmationDialog.style.display = 'block';
            } else {
                confirmReplaceInput.value = 'no';
                uploadForm.submit();
            }
        });
        confirmActionButton.addEventListener('click', function() {
            if (pendingAction === 'replace') {
                confirmReplaceInput.value = 'yes';
                confirmationDialog.style.display = 'none';
                uploadForm.submit();
            } else if (pendingAction === 'delete') {
                confirmationDialog.style.display = 'none';
                performDelete();
            }
        });
        cancelActionButton.addEventListener('click', function() {
            pendingAction = null;
            confirmationDialog.style.display = 'none';
        });

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        $("#search-button").on("click", function () {
            var dni = $("#search-dni").val().trim();
            if (!dni) { return; } // No-op on empty search
            // Clear Django message banners on interaction
            $(".messages").remove();
            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? texts.voted : texts.not_voted;
                        const actionButtonText = voter.voted ? texts.unmark : texts.mark_voted;
                        const statusClass = voter.voted ? 'ok' : 'bad';
                        const voterHtml = `
                            <div class="voter-box ${statusClass}">
                                <p><strong>${texts.name}:</strong> ${voter.name}</p>
                                <p><strong>${texts.dni}:</strong> ${voter.dni}</p>
                                <p><strong>${texts.status}:</strong> <span class="status-badge ${statusClass} voted-status">${votedStatusText}</span></p>
                                <p><a href="#" class="mark-voted" data-voter-id="${voter.id}">${actionButtonText}</a></p>
                            </div>
                        `;
                        $("#voter-details").html(voterHtml);
                    } else if (response.status === "no_data") {
                        $("#voter-details").html(`<p class="error-message">Sin datos, por favor cargue una lista de votantes primero</p>`);
                    } else if (response.status === "not_found") {
                        $("#voter-details").html(`<p class="error-message">${texts.no_voter_found}</p>`);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    }
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                }
            });
        });

        function updateVoterStats() {
            $.ajax({
                url: "{% url 'voting:get_voter_stats' %}",
                type: "GET",
                success: function(response) {
                    if (response.status === "success") {
                        const stats = response.stats;
                        // Update currentVoterCount for future decisions
                        currentVoterCount = stats.total_voters;
                        // Enable/disable delete button depending on if a list is loaded
                        if (stats.total_voters > 0) {
                            clearListButton.disabled = false;
                        } else {
                            clearListButton.disabled = true;
                        }
                        if (stats.total_voters === 0) {
                            $('.progress-stats, .progress-bar').hide();
                            $('.no-voters-message').show();
                        } else {
                            $('.progress-stats, .progress-bar').show();
                            $('.no-voters-message').hide();
                                $('.progress-fill').css('width', `${stats.percentage}%`);
                                // Using replace with Spanish templates
                                $('.voted-count').text(texts.n_voted.replace('{n}', stats.voted_count));
                                $('.percentage').text(`${stats.percentage}%`);
                                $('.total-voters').text(texts.n_total_voters.replace('{n}', stats.total_voters));
                        }
                    }
                }
            });
        }

        // Initial call to update stats
        updateVoterStats();

        // Event delegation for marking a voter
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            // Clear Django message banners on interaction
            $(".messages").remove();
            var voterId = $(this).data("voter-id");
            var button = $(this);
            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function (response) {
                    if (response.status === "success") {
                        var container = button.closest('.voter-box');
                        var statusSpan = container.find('.voted-status');
                        var currentlyVoted = statusSpan.text() === texts.voted;
                        if (currentlyVoted) {
                            statusSpan.text(texts.not_voted)
                                .removeClass('ok').addClass('bad');
                            container.removeClass('ok').addClass('bad');
                            button.text(texts.mark_voted);
                        } else {
                            statusSpan.text(texts.voted)
                                .removeClass('bad').addClass('ok');
                            container.removeClass('bad').addClass('ok');
                            button.text(texts.unmark);
                        }
                        // After marking a voter, update the overall progress stats
                        updateVoterStats();
                    }
                }
            });
        });

        // Clear list handler
        clearListButton.addEventListener('click', function() {
            $(".messages").remove();
            pendingAction = 'delete';
            confirmationMessage.textContent = '¿Seguro que deseas borrar toda la lista de votantes? Esta acción no se puede deshacer.';
            confirmationDialog.style.display = 'block';
        });

        function performDelete() {
            $.ajax({
                url: "{% url 'voting:clear_voters' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function(response) {
                    if (response.status === 'success') {
                        $("#voter-details").empty();
                        currentVoterCount = 0;
                        showInlineFeedback('Lista borrada correctamente', 'success');
                        updateVoterStats();
                    } else {
                        showInlineFeedback(response.message || 'No se pudo borrar la lista', 'error');
                    }
                },
                error: function() {
                    showInlineFeedback('Error al intentar borrar la lista', 'error');
                }
            });
        }

        const FEEDBACK_TIMEOUT = 7500; // extended visibility
        function showInlineFeedback(message, type) {
            inlineFeedback.textContent = message;
            inlineFeedback.className = 'inline-feedback ' + (type === 'success' ? 'ok' : 'bad');
            inlineFeedback.style.display = 'block';
            setTimeout(() => { inlineFeedback.style.display = 'none'; }, FEEDBACK_TIMEOUT);
        }

        // Detect ?uploaded=1 param to show success feedback after redirect
        (function handleUploadParam(){
            const params = new URLSearchParams(window.location.search);
            if (params.get('uploaded') === '1') {
                showInlineFeedback('Lista cargada correctamente', 'success');
                params.delete('uploaded');
                const newQs = params.toString();
                const newUrl = window.location.pathname + (newQs ? '?' + newQs : '');
                window.history.replaceState({}, '', newUrl);
            }
        })();
    }
    // Initialize page behavior now that TEXTS is defined
    initializePage(TEXTS);
});
</script>
{% endblock %}
