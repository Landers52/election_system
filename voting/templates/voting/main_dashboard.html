{% extends 'base.html' %}
{% load static %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'voting/css/main_dashboard.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
<div class="text-center" style="margin-top: 8px;">
    <!-- Organization name temporarily hidden -->
    <h1 class="mt-0 mb-8" style="font-weight:700;">Panel Principal</h1>
</div>
<p class="muted mt-0">Cargá, administrá y monitoreá el avance de votación por zona.</p>
<div id="inline-feedback" class="inline-feedback hidden"></div>

<!-- Actions grid: izquierda (carga), derecha (borrado) -->
<div class="actions-grid">
    <div class="col card">
        <!-- Votantes: Carga -->
    <form id="upload-form" method="post" enctype="multipart/form-data" data-voter-count="{{ voter_count|default:0 }}" autocomplete="off">
            {% csrf_token %}
            <input type="hidden" name="confirm_replace" id="confirm-replace" value="no">
            <input type="hidden" name="confirm_password" id="confirm-password-hidden" value="">
            <div class="custom-file-upload">
                <input type="file" name="file" id="file" class="file-input" required style="display:none;" accept=".xlsx">
                <div class="file-actions-row">
                                <label for="file" class="file-label button-like-label nowrap">
                        Elegir archivo <span class="file-text">(ninguno seleccionado)</span>
                    </label>
                    <button type="submit" id="upload-button" class="btn btn-primary">Subir lista</button>
                    <button type="button" id="upload-zone-button" class="btn btn-success">Subir a nueva zona</button>
                </div>
            </div>
        </form>
        <small class="hint">Formatos aceptados: .xlsx (Excel). La importación ignora filas sin DNI o Nombre.</small>
    </div>
    <div class="col card">
        <div class="delete-box">
            <button id="clear-list-button" class="btn btn-soft-danger" type="button" disabled>Borrar lista</button>
            <small class="hint">Elimina todos los votantes cargados para tu cuenta. Esta acción no se puede deshacer.</small>
        </div>
    </div>
</div>

<!-- Diálogo de confirmación -->
<div id="confirmation-dialog" class="confirmation-dialog card hidden max-w-520">
    <p id="confirmation-message">Confirmar acción</p>
    <div class="modal-body">
        <label for="confirm-password-input"><strong>Contraseña</strong></label>
    <input id="confirm-password-input" type="password" placeholder="Ingrese la contraseña" autocomplete="new-password" autocapitalize="off" autocorrect="off" spellcheck="false" data-lpignore="true" name="confirm-password-modal" />
        <div id="confirm-password-error" class="modal-error" style="display:none;"></div>
    </div>
    <div class="dialog-buttons">
    <button id="confirm-action-button" class="btn btn-danger">Confirmar</button>
        <button id="cancel-action-button" class="btn">Cancelar</button>
    </div>
</div>

<!-- Modal: subir a nueva zona -->
<div id="zone-upload-overlay" class="modal-overlay hidden"></div>
<div id="zone-upload-dialog" class="modal-dialog hidden">
    <h3>Subir a nueva zona</h3>
    <div class="modal-body">
        <label for="zone-name-input"><strong>Nombre de la zona</strong></label>
        <input id="zone-name-input" type="text" placeholder="Ej: Barrio Centro" />
        <div id="zone-name-error" class="modal-error" style="display:none;"></div>
    </div>
    <div class="dialog-buttons">
    <button id="zone-upload-confirm" class="btn btn-primary">Subir</button>
        <button id="zone-upload-cancel" class="btn">Cancelar</button>
    </div>
    <small class="hint">Se creará la zona si no existe. Evitaremos nombres duplicados.</small>
    <div class="modal-close" id="zone-upload-close">×</div>
</div>

<hr>

<!-- Buscador de votantes -->
<div class="search-row card row p-10">
    <input type="text" id="search-dni" placeholder="Buscar por DNI" inputmode="numeric" pattern="[0-9]*" class="w-100 max-w-220">
    <button id="search-button" class="btn btn-primary">Buscar</button>
</div>

<!-- Resultado de búsqueda -->
<div id="voter-details" class="card mt-14">
    <!-- Search results will be displayed here -->
    <div id="voter-skeleton" class="skeleton skeleton-card hidden"></div>
</div>

<hr>

<!-- Progreso general -->
<div class="progress-container card" id="overall-progress">
    <div class="overall-header">
        <h3>Progreso de Votación (General)</h3>
        <span class="overall-summary">0/0 (0%)</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <div class="no-voters-message" style="display: none;">
        No se han registrado votantes aún. Por favor sube una lista de votantes para comenzar.
    </div>
    <div id="stats-skeleton" class="skeleton skeleton-bar hidden mt-8"></div>
</div>

<!-- Progreso por zona -->
<div id="zone-progress-list" class="zone-progress-list mt-16"></div>
<div id="zone-skeleton" class="skeleton skeleton-card hidden mt-16"></div>

<!-- Gráfico por zonas -->
<div id="zone-chart-wrap" class="card mt-16">
    <h3>Distribución por zonas</h3>
    <canvas id="zone-distribution-chart" height="120"></canvas>
    <div id="no-zone-chart" class="status-hint" style="display:none;">No hay datos de zonas para graficar.</div>
</div>

<script>
$(document).ready(function () {
    // Spanish-only text constants
    const TEXTS = {
        please_select_file: 'Por favor seleccione un archivo para subir.',
        no_file_selected: 'Ningún archivo seleccionado',
        enter_dni: 'Por favor ingrese un DNI para buscar.',
    voted: 'Votó',
    not_voted: 'No votó',
        unmark: 'Desmarcar como Votado',
        mark_voted: 'Marcar como Votado',
        name: 'Nombre',
        dni: 'DNI',
        status: 'Estado',
        no_voter_found: 'No se encontró un votante con ese DNI.',
        error_occurred: 'Ocurrió un error al buscar.',
        n_voted: '{n} votados',
        n_total_voters: '{n} votantes en total'
    };

    function initializePage(texts) {
        const uploadForm = document.getElementById('upload-form');
        // Dynamic voter count that can be refreshed after actions
        let currentVoterCount = parseInt(uploadForm.getAttribute('data-voter-count'), 10) || 0;
        const fileInput = document.getElementById('file');
        const confirmationDialog = document.getElementById('confirmation-dialog');
        const confirmActionButton = document.getElementById('confirm-action-button');
        const cancelActionButton = document.getElementById('cancel-action-button');
        const confirmationMessage = document.getElementById('confirmation-message');
        const confirmReplaceInput = document.getElementById('confirm-replace');
        const confirmPasswordHidden = document.getElementById('confirm-password-hidden');
        const confirmPasswordInput = document.getElementById('confirm-password-input');
        const confirmPasswordError = document.getElementById('confirm-password-error');
    const clearListButton = document.getElementById('clear-list-button');
    const inlineFeedback = document.getElementById('inline-feedback');
    const voterSkeleton = document.getElementById('voter-skeleton');
    const statsSkeleton = document.getElementById('stats-skeleton');
    const zoneSkeleton = document.getElementById('zone-skeleton');
    // Zone modal elements
    const zoneOverlay = document.getElementById('zone-upload-overlay');
    const zoneDialog = document.getElementById('zone-upload-dialog');
    const zoneNameInput = document.getElementById('zone-name-input');
    const zoneNameError = document.getElementById('zone-name-error');
    const zoneConfirmBtn = document.getElementById('zone-upload-confirm');
    const zoneCancelBtn = document.getElementById('zone-upload-cancel');
    const zoneCloseBtn = document.getElementById('zone-upload-close');
    // Known zones cache for duplicate prevention
    let knownZones = new Set();
    // Chart.js instance
    let zoneChart = null;
        let pendingAction = null; // 'replace' | 'delete'

        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            const fileTextSpan = document.querySelector('.file-text');
            if (fileName) {
                fileTextSpan.textContent = `(${fileName})`;
            } else {
                fileTextSpan.textContent = `(${texts.no_file_selected})`;
            }
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!fileInput.files || fileInput.files.length === 0) {
                alert(texts.please_select_file);
                return;
            }
            // Clear Django message banners on interaction
            $(".messages").remove();
            // Show confirmation only if there are existing voters
            if (currentVoterCount > 0) {
                pendingAction = 'replace';
                confirmationMessage.textContent = 'Ya existe una lista cargada. ¿Deseas reemplazarla con la nueva?';
                if (confirmPasswordInput) { confirmPasswordInput.value = ''; }
                if (confirmPasswordError) { confirmPasswordError.style.display = 'none'; }
                confirmationDialog.style.display = 'block';
            } else {
                confirmReplaceInput.value = 'no';
                uploadForm.submit();
            }
        });
        confirmActionButton.addEventListener('click', function() {
            if (pendingAction === 'replace') {
                const pwd = (confirmPasswordInput?.value || '').trim();
                if (!pwd) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Ingrese la contraseña.';
                        confirmPasswordError.style.display = 'block';
                    }
                    return;
                }
                // Pre-validate password via lightweight endpoint; on success, submit form
                $.ajax({
                    url: "{% url 'voting:validate_password' %}",
                    type: "POST",
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    data: { confirm_password: pwd },
                    success: function(resp){
                        if (resp && resp.status === 'success') {
                            if (confirmPasswordHidden) confirmPasswordHidden.value = pwd;
                            confirmReplaceInput.value = 'yes';
                            confirmationDialog.style.display = 'none';
                            uploadForm.submit();
                        } else {
                            if (confirmPasswordError) {
                                confirmPasswordError.textContent = (resp && resp.message) || 'Contraseña incorrecta.';
                                confirmPasswordError.style.display = 'block';
                            }
                        }
                    },
                    error: function(){
                        if (confirmPasswordError) {
                            confirmPasswordError.textContent = 'No se pudo validar la contraseña. Intenta nuevamente.';
                            confirmPasswordError.style.display = 'block';
                        }
                    }
                });
            } else if (pendingAction === 'delete') {
                const pwd = (confirmPasswordInput?.value || '').trim();
                if (!pwd) {
                    if (confirmPasswordError) {
                        confirmPasswordError.textContent = 'Ingrese la contraseña.';
                        confirmPasswordError.style.display = 'block';
                    }
                    return;
                }
                // Pre-validate password just like replace, then execute delete
                $.ajax({
                    url: "{% url 'voting:validate_password' %}",
                    type: "POST",
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    data: { confirm_password: pwd },
                    success: function(resp){
                        if (resp && resp.status === 'success') {
                            confirmationDialog.style.display = 'none';
                            performDelete(pwd);
                        } else {
                            if (confirmPasswordError) {
                                confirmPasswordError.textContent = (resp && resp.message) || 'Contraseña incorrecta.';
                                confirmPasswordError.style.display = 'block';
                            }
                        }
                    },
                    error: function(){
                        if (confirmPasswordError) {
                            confirmPasswordError.textContent = 'No se pudo validar la contraseña. Intenta nuevamente.';
                            confirmPasswordError.style.display = 'block';
                        }
                    }
                });
            }
        });
        cancelActionButton.addEventListener('click', function() {
            pendingAction = null;
            confirmationDialog.style.display = 'none';
            if (confirmPasswordInput) confirmPasswordInput.value = '';
            if (confirmPasswordError) confirmPasswordError.style.display = 'none';
        });

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        function triggerSearch(){
            var dni = $("#search-dni").val().trim();
            if (!dni) { return; } // No-op on empty search
            // Clear Django message banners on interaction
            $(".messages").remove();
            // Show skeleton
            if (voterSkeleton) voterSkeleton.classList.remove('hidden');
            $("#voter-details").empty();
            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? texts.voted : texts.not_voted;
                        const actionButtonText = voter.voted ? texts.unmark : texts.mark_voted;
                        const statusClass = voter.voted ? 'ok' : 'bad';
                        const voterHtml = `
                            <div class="voter-box ${statusClass}">
                                <p><strong>${texts.name}:</strong> ${voter.name}</p>
                                <p><strong>${texts.dni}:</strong> ${voter.dni}</p>
                                <p><strong>Zona:</strong> ${voter.zone || 'Sin asignar'}</p>
                                <p><strong>${texts.status}:</strong> <span class="status-badge ${statusClass} voted-status mark-voted" data-voter-id="${voter.id}" data-voted="${voter.voted}" title="Cambiar estado">${votedStatusText}</span></p>
                            </div>
                        `;
                        $("#voter-details").html(voterHtml);
                    } else if (response.status === "no_data") {
                        $("#voter-details").html(`<p class="error-message">Sin datos, por favor cargue una lista de votantes primero</p>`);
                    } else if (response.status === "not_found") {
                        $("#voter-details").html(`<p class="error-message">${texts.no_voter_found}</p>`);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    }
                    if (voterSkeleton) voterSkeleton.classList.add('hidden');
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${texts.error_occurred}</p>`);
                    if (voterSkeleton) voterSkeleton.classList.add('hidden');
                }
            });
        }

        $("#search-button").on("click", triggerSearch);
        $("#search-dni").on("keyup", function(e){ if (e.key === 'Enter') { triggerSearch(); } });

        function updateVoterStats() {
            if (statsSkeleton) statsSkeleton.classList.remove('hidden');
            $.ajax({
                url: "{% url 'voting:get_voter_stats' %}",
                type: "GET",
                success: function(response) {
                    if (response.status === "success") {
                        const stats = response.stats;
                        // Update currentVoterCount for future decisions
                        currentVoterCount = stats.total_voters;
                        // Enable/disable delete button depending on if a list is loaded
                        if (stats.total_voters > 0) {
                            clearListButton.disabled = false;
                        } else {
                            clearListButton.disabled = true;
                        }
                        if (stats.total_voters === 0) {
                            $('#overall-progress .progress-bar').hide();
                            $('#overall-progress .overall-summary').hide();
                            $('#overall-progress .no-voters-message').show();
                        } else {
                            $('#overall-progress .progress-bar').show();
                            $('#overall-progress .overall-summary').show();
                            $('#overall-progress .no-voters-message').hide();
                            $('#overall-progress .progress-fill').css('width', `${stats.percentage}%`);
                            // Unified summary like zone items: "voted/total (percent%)"
                            $('#overall-progress .overall-summary').text(`${stats.voted_count}/${stats.total_voters} (${stats.percentage}%)`);
                        }
                    }
                    if (statsSkeleton) statsSkeleton.classList.add('hidden');
                },
                error: function(){
                    if (statsSkeleton) statsSkeleton.classList.add('hidden');
                }
            });
        }

        function renderZoneBars(zones) {
                const container = $('#zone-progress-list');
                // Preserve which zones were expanded
                const expanded = new Set();
                container.find('.zone-pending-block').each(function(){
                    const zid = $(this).data('zone-id');
                    if ($(this).is(':visible')) expanded.add(String(zid));
                });
                container.empty();
                if (!zones || zones.length === 0) return;
                zones.forEach(z => {
                    const pct = z.percentage || 0;
                    const pendingCount = Math.max((z.total_voters || 0) - (z.voted_count || 0), 0);
                    const zoneItem = $(`
                        <div class="zone-item" data-zone-id="${z.id}">
                            <div class="zone-header">
                                <span class="zone-name">${z.name}</span>
                                <span class="zone-stats">${z.voted_count}/${z.total_voters} (${pct}%)</span>
                            </div>
                            <div class="zone-bar">
                                <div class="zone-fill" style="width:${pct}%"></div>
                            </div>
                            <div class="row mt-8">
                                <button class="btn btn-purple zone-toggle-pending" data-zone-id="${z.id}">${pendingCount} pendientes</button>
                                ${z.name === 'Sin asignar' ? `<button class="btn btn-success zone-refresh-pending" data-zone-id="${z.id}">Actualizar</button>` : ''}
                            </div>
                            <div class="zone-pending-block mt-8" data-zone-id="${z.id}" style="display:none;">
                                <div class="pending-list" style="max-height:600px;"></div>
                                <div class="row mt-6">
                                    <button class="btn zone-load-more" data-zone-id="${z.id}" style="display:none;">Cargar más</button>
                                    <span class="muted zone-pending-meta" style="display:none; font-size:.85rem;"></span>
                                </div>
                            </div>
                        </div>
                    `);
                    container.append(zoneItem);
                });
                // Re-open expanded zones
                expanded.forEach(function(zid){
                    const block = container.find(`.zone-pending-block[data-zone-id="${zid}"]`);
                    if (block.length) {
                        block.show();
                        // If empty, trigger load
                        if (!block.data('loaded')) {
                            loadZonePending(zid, 1);
                        }
                    }
                });
            }

            // Per-zone pending state
            const zonePendingState = {}; // { [zoneId]: { page: number, hasMore: bool, total: number } }

            function loadZonePending(zoneId, nextPage) {
                const block = $(`.zone-pending-block[data-zone-id="${zoneId}"]`);
                if (!block.length) return;
                const list = block.find('.pending-list');
                const loadMoreBtn = block.find('.zone-load-more');
                const meta = block.find('.zone-pending-meta');
                $.get('{% url "voting:pending_voters" %}', { zone_id: zoneId, page: nextPage, page_size: 1000 }, function(resp){
                    if (resp.status !== 'success') return;
                    const state = zonePendingState[zoneId] || { page: 0, hasMore: false, total: 0 };
                    state.page = resp.page;
                    state.hasMore = resp.has_more;
                    state.total = resp.total;
                    zonePendingState[zoneId] = state;
                    renderZonePending(zoneId, resp.voters, state);
                    block.data('loaded', true);
                });
            }

            function renderZonePending(zoneId, voters, state) {
                const block = $(`.zone-pending-block[data-zone-id="${zoneId}"]`);
                if (!block.length) return;
                const list = block.find('.pending-list')[0];
                const loadMoreBtn = block.find('.zone-load-more');
                const meta = block.find('.zone-pending-meta');
                // If first page, clear list
                if (state.page === 1) {
                    list.innerHTML = '';
                }
                const frag = document.createDocumentFragment();
                (voters || []).forEach(v => {
                    const div = document.createElement('div');
                    div.className = 'pending-item';
                    const ln = v.last_name || '';
                    const fn = v.first_name || '';
                    const sx = v.sex || '';
                    const addr = v.address || '';
                    const mesa = (v.mesa ?? '') === null ? '' : (v.mesa ?? '');
                    const orden = (v.orden ?? '') === null ? '' : (v.orden ?? '');
                    const est = v.establecimiento || '';
                    div.textContent = `${v.dni} - ${ln}, ${fn} | Sexo: ${sx} | Dirección: ${addr} | Mesa: ${mesa} | Orden: ${orden} | Establecimiento: ${est}`;
                    frag.appendChild(div);
                });
                list.appendChild(frag);
                // Meta and load more
                const shown = list.children.length;
                if (state.total > 0) {
                    meta.show().text(`Mostrando ${shown} de ${state.total} pendientes (${((shown/state.total)*100).toFixed(1)}%)`);
                } else {
                    meta.show().text('No hay pendientes');
                }
                if (state.hasMore) {
                    loadMoreBtn.show();
                } else {
                    loadMoreBtn.hide();
                }
            }

            // Toggle and pagination handlers
            $('#zone-progress-list').on('click', '.zone-toggle-pending', function(){
                const zid = String($(this).data('zone-id'));
                const block = $(`.zone-pending-block[data-zone-id="${zid}"]`);
                if (!block.length) return;
                const isVisible = block.is(':visible');
                if (isVisible) {
                    block.hide();
                } else {
                    block.show();
                    // If not loaded or was cleared, load first page
                    const state = zonePendingState[zid];
                    if (!state || state.page === 0) {
                        loadZonePending(zid, 1);
                    }
                }
            });
            $('#zone-progress-list').on('click', '.zone-load-more', function(){
                const zid = String($(this).data('zone-id'));
                const state = zonePendingState[zid];
                const next = (state?.page || 0) + 1;
                loadZonePending(zid, next);
            });

            // Manual refresh for "Sin asignar" zone only
            $('#zone-progress-list').on('click', '.zone-refresh-pending', function(){
                const zid = String($(this).data('zone-id'));
                const block = $(`.zone-pending-block[data-zone-id="${zid}"]`);
                // Ensure the block is visible
                if (!block.is(':visible')) {
                    block.show();
                }
                // Reset state and list, then load first page fresh
                zonePendingState[zid] = { page: 0, hasMore: false, total: 0 };
                block.data('loaded', false);
                const list = block.find('.pending-list');
                list.empty();
                const meta = block.find('.zone-pending-meta');
                meta.hide().text('');
                const loadMoreBtn = block.find('.zone-load-more');
                loadMoreBtn.hide();
                loadZonePending(zid, 1);
            });

        function updateZoneStats() {
            if (zoneSkeleton) zoneSkeleton.classList.remove('hidden');
            $.ajax({
                url: '{% url "voting:get_zone_stats" %}',
                type: 'GET',
                success: function(resp){
                    if (resp.status === 'success') {
                        renderZoneBars(resp.zones);
                        // populate known zones (case-insensitive)
                        knownZones = new Set((resp.zones || []).map(z => (z.name || '').trim().toLowerCase()));
                        renderZoneChart(resp.zones || []);
                    }
                    if (zoneSkeleton) zoneSkeleton.classList.add('hidden');
                },
                error: function(){
                    if (zoneSkeleton) zoneSkeleton.classList.add('hidden');
                }
            });
        }

        function renderZoneChart(zones) {
            const wrap = document.getElementById('zone-chart-wrap');
            const empty = document.getElementById('no-zone-chart');
            const canvas = document.getElementById('zone-distribution-chart');
            const ctx = canvas.getContext('2d');
            const labels = zones.map(z => z.name);
            const data = zones.map(z => z.total_voters);
            const hasData = data.some(v => v > 0);
            if (!hasData) {
                if (zoneChart) { zoneChart.destroy(); zoneChart = null; }
                empty.style.display = 'block';
                canvas.style.display = 'none';
                return;
            }
            empty.style.display = 'none';
            canvas.style.display = 'block';
            const colors = [
                '#0d6efd','#198754','#dc3545','#6f42c1','#fd7e14',
                '#20c997','#0dcaf0','#6610f2','#ffc107','#d63384'
            ];
            const bgColors = labels.map((_, i) => colors[i % colors.length]);
            const ds = {
                labels,
                datasets: [{
                    data,
                    backgroundColor: bgColors,
                    borderWidth: 1,
                }]
            };
            // Always destroy and recreate to avoid resize compounding
            if (zoneChart) { zoneChart.destroy(); zoneChart = null; }
            zoneChart = new Chart(ctx, {
                type: 'doughnut',
                data: ds,
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.4,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

    // Initial call to update stats
    updateVoterStats();
    updateZoneStats();

        // Event delegation for marking a voter
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            // Clear Django message banners on interaction
            $(".messages").remove();
            var voterId = $(this).data("voter-id");
            var badge = $(this);
            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function (response) {
                    if (response.status === "success") {
                        var container = badge.closest('.voter-box');
                        var statusSpan = container.find('.voted-status');
                        var newVoted = response.voted === true;
                        statusSpan.text(newVoted ? texts.voted : texts.not_voted)
                            .toggleClass('ok', newVoted)
                            .toggleClass('bad', !newVoted)
                            .attr('data-voted', newVoted);
                        container.toggleClass('ok', newVoted).toggleClass('bad', !newVoted);
                        // After marking a voter, update the overall progress stats and zone bars
                        updateVoterStats();
                        updateZoneStats();
                    }
                }
            });
        });

        // Clear list handler
        clearListButton.addEventListener('click', function() {
            $(".messages").remove();
            pendingAction = 'delete';
            confirmationMessage.textContent = '¿Seguro que deseas borrar toda la lista de votantes? Esta acción no se puede deshacer.';
            if (confirmPasswordInput) confirmPasswordInput.value = '';
            if (confirmPasswordError) confirmPasswordError.style.display = 'none';
            confirmationDialog.style.display = 'block';
        });

        function performDelete(password) {
            $.ajax({
                url: "{% url 'voting:clear_voters' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { confirm_password: password },
                success: function(response) {
                    if (response.status === 'success') {
                        $("#voter-details").empty();
                        currentVoterCount = 0;
                        showInlineFeedback('Lista borrada correctamente', 'success');
                        updateVoterStats();
                        updateZoneStats();
                    } else {
                        // If any unexpected server error occurs (other than password), show a single inline toast
                        showInlineFeedback(response.message || 'No se pudo borrar la lista', 'error');
                    }
                },
                error: function() {
                    showInlineFeedback('Error al intentar borrar la lista', 'error');
                }
            });
        }

        const FEEDBACK_TIMEOUT = 7500; // extended visibility
        function showInlineFeedback(message, type) {
            inlineFeedback.textContent = message;
            inlineFeedback.className = 'inline-feedback ' + (type === 'success' ? 'ok' : 'bad');
            inlineFeedback.style.display = 'block';
            setTimeout(() => { inlineFeedback.style.display = 'none'; }, FEEDBACK_TIMEOUT);
        }

        // Detect ?uploaded=1 param to show success feedback after redirect
        (function handleUploadParam(){
            const params = new URLSearchParams(window.location.search);
            if (params.get('uploaded') === '1') {
                showInlineFeedback('Lista cargada correctamente', 'success');
                params.delete('uploaded');
                const newQs = params.toString();
                const newUrl = window.location.pathname + (newQs ? '?' + newQs : '');
                window.history.replaceState({}, '', newUrl);
            }
        })();

        // Upload to new zone logic
        // Zone upload modal behavior
        function openZoneModal() {
            zoneNameInput.value = '';
            zoneNameError.style.display = 'none';
            zoneOverlay.style.display = 'block';
            zoneDialog.style.display = 'block';
            zoneNameInput.focus();
        }
        function closeZoneModal() {
            zoneOverlay.style.display = 'none';
            zoneDialog.style.display = 'none';
        }
        function validateZoneName(name) {
            const n = (name || '').trim();
            if (!n) { return 'Ingrese un nombre de zona.'; }
            if (knownZones.has(n.toLowerCase())) { return 'Ya existe una zona con ese nombre.'; }
            return '';
        }
        document.getElementById('upload-zone-button').addEventListener('click', function(){
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Primero seleccione un archivo (.xlsx).');
                return;
            }
            openZoneModal();
        });
        zoneCancelBtn.addEventListener('click', closeZoneModal);
        zoneCloseBtn.addEventListener('click', closeZoneModal);
        zoneOverlay.addEventListener('click', closeZoneModal);
        zoneConfirmBtn.addEventListener('click', function(){
            const zoneName = zoneNameInput.value;
            const error = validateZoneName(zoneName);
            if (error) {
                zoneNameError.textContent = error;
                zoneNameError.style.display = 'block';
                return;
            }
            zoneNameError.style.display = 'none';
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('zone_name', zoneName.trim());
            $.ajax({
                url: '{% url "voting:upload_voters_to_zone" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': getCSRFToken() },
                success: function(resp){
                    if (resp.status === 'success') {
                        closeZoneModal();
                        showInlineFeedback(`Zona "${resp.zone}": ${resp.created} nuevos, ${resp.updated} actualizados, ${resp.skipped} omitidos`, 'success');
                        updateVoterStats();
                        updateZoneStats(); // ensure new zone appears immediately
                        // Scroll to charts/bars for quick visibility
                        const chartEl = document.getElementById('zone-chart-wrap');
                        if (chartEl) { chartEl.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
                    } else {
                        showInlineFeedback(resp.message || 'Error al subir la lista a la zona', 'error');
                    }
                },
                error: function(){
                    showInlineFeedback('Error al subir la lista a la zona', 'error');
                }
            });
        });
    }
    // Initialize page behavior now that TEXTS is defined
    initializePage(TEXTS);
});
</script>
{% endblock %}
