{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="{% static 'css/main_dashboard.css' %}">
{% endblock %}
{% block content %}
<h1>{% trans "Welcome to the Main Dashboard" %}</h1>

<!-- Progress Bar Section -->
<div class="progress-container">
    <h3>{% trans "Voting Progress" %}</h3>
    <div class="progress-bar">
        <div class="progress-fill"></div>
    </div>
    <div class="progress-stats">
        <span class="voted-count">{% trans "0 voted" %}</span>
        <span class="percentage">{% trans "0%" %}</span>
        <span class="total-voters">{% trans "0 total voters" %}</span>
    </div>
    <div class="no-voters-message" style="display: none;">
        {% trans "No voters have been registered yet. Please upload a voter list to begin." %}
    </div>
</div>

<!-- Voter Upload Form -->
{# Pass voter count via data attribute to avoid JS linter issues with Django tags #}
<form id="upload-form" method="post" enctype="multipart/form-data" data-voter-count="{{ voter_count|default:0 }}">
    {% csrf_token %}
    <input type="hidden" name="confirm_replace" id="confirm-replace" value="no"> {# Hidden field for confirmation #}
    <div class="custom-file-upload">
        <input type="file" name="file" id="file" class="file-input" required style="display: none;" accept=".xlsx"> {# Added accept attribute for Excel files #}
        <label for="file" class="file-label button-like-label">
            {% trans "Choose file" %} <span class="file-text">({% trans "No file selected" %})</span>
        </label>
    </div>
    <button type="submit" id="upload-button">{% trans "Upload Voter List" %}</button>
</form>

<!-- Confirmation Dialog (Initially Hidden) -->
<div id="confirmation-dialog" class="confirmation-dialog" style="display: none;">
    <p>{% trans "Voters already exist in the system. Do you want to replace them with the new list?" %}</p>
    <button id="confirm-replace-button">{% trans "Yes, Replace" %}</button>
    <button id="cancel-replace-button">{% trans "No, Cancel" %}</button>
</div>


<hr>

<!-- Search Bar -->
<input type="text" id="search-dni" placeholder="{% trans 'Search by DNI' %}">
<button id="search-button">{% trans "Search" %}</button>

<!-- Voter Details Area -->
<div id="voter-details" style="margin-top: 20px;">
    <!-- Search results will be displayed here -->
</div>

<hr>

<script>
$(document).ready(function () {
    let translations = {};

    // Get the current language code from the URL path (e.g., /en/ or /es/)
    const lang = window.location.pathname.split('/')[1] || 'en';

    // Asynchronously fetch translations from the server, passing the language
    $.ajax({
        url: `{% url 'voting:get_translations' %}?lang=${lang}`,
        method: 'GET',
        success: function(data) {
            translations = data;
            // Once translations are loaded, initialize the rest of the page functionality
            initializePage(translations);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error("Failed to load translations:", textStatus, errorThrown);
            // Initialize with an empty object, which will cause fallbacks in the functions
            initializePage({}); 
        }
    });

    function initializePage(translations) {
        const uploadForm = document.getElementById('upload-form');
        // Use a fallback for voter count if the attribute is missing
        const initialVoterCount = parseInt(uploadForm.getAttribute('data-voter-count'), 10) || 0;
        const fileInput = document.getElementById('file');
        const confirmationDialog = document.getElementById('confirmation-dialog');
        const confirmReplaceButton = document.getElementById('confirm-replace-button');
        const cancelReplaceButton = document.getElementById('cancel-replace-button');
        const confirmReplaceInput = document.getElementById('confirm-replace');

        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name;
            const fileTextSpan = document.querySelector('.file-text');
            if (fileName) {
                fileTextSpan.textContent = `(${fileName})`;
            } else {
                // Use fallback text if translation not available
                fileTextSpan.textContent = `(${translations.no_file_selected || 'No file selected'})`;
            }
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!fileInput.files || fileInput.files.length === 0) {
                alert(translations.please_select_file || 'Please select a file to upload.');
                return;
            }
            // Show confirmation only if there are existing voters
            if (initialVoterCount > 0) {
                confirmationDialog.style.display = 'block';
            } else {
                confirmReplaceInput.value = 'no';
                uploadForm.submit();
            }
        });

        confirmReplaceButton.addEventListener('click', function() {
            confirmReplaceInput.value = 'yes';
            confirmationDialog.style.display = 'none';
            uploadForm.submit();
        });

        cancelReplaceButton.addEventListener('click', function() {
            confirmReplaceInput.value = 'no';
            confirmationDialog.style.display = 'none';
        });

        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        $("#search-button").on("click", function () {
            var dni = $("#search-dni").val().trim();
            if (!dni) {
                alert(translations.enter_dni || 'Please enter a DNI to search.');
                return;
            }
            $.ajax({
                url: "{% url 'voting:search_voter_by_dni' %}",
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                data: { 'dni': dni },
                success: function (response) {
                    $("#voter-details").empty();
                    if (response.status === "success" && response.voter) {
                        const voter = response.voter;
                        const votedStatusText = voter.voted ? (translations.voted || 'Voted') : (translations.not_voted || 'Not Voted');
                        const actionButtonText = voter.voted ? (translations.unmark || 'Unmark as Voted') : (translations.mark_voted || 'Mark as Voted');
                        const voterHtml = `
                            <p><strong>${translations.name || 'Name'}:</strong> ${voter.name}</p>
                            <p><strong>${translations.dni || 'DNI'}:</strong> ${voter.dni}</p>
                            <p><strong>${translations.status || 'Status'}:</strong> <span class="voted-status">${votedStatusText}</span></p>
                            <p><a href="#" class="mark-voted" data-voter-id="${voter.id}">${actionButtonText}</a></p>
                        `;
                        $("#voter-details").html(voterHtml);
                    } else {
                        $("#voter-details").html(`<p class="error-message">${translations.no_voter_found || 'No voter found with that DNI.'}</p>`);
                    }
                },
                error: function () {
                    $("#voter-details").html(`<p class="error-message">${translations.no_voter_found || 'An error occurred while searching.'}</p>`);
                }
            });
        });

        function updateVoterStats() {
            $.ajax({
                url: "{% url 'voting:get_voter_stats' %}",
                type: "GET",
                success: function(response) {
                    if (response.status === "success") {
                        const stats = response.stats;
                        if (stats.total_voters === 0) {
                            $('.progress-stats, .progress-bar').hide();
                            $('.no-voters-message').show();
                        } else {
                            $('.progress-stats, .progress-bar').show();
                            $('.no-voters-message').hide();
                            $('.progress-fill').css('width', `${stats.percentage}%`);
                            // Using replace with fallbacks
                            $('.voted-count').text((translations.n_voted || '{n} voted').replace('{n}', stats.voted_count));
                            $('.percentage').text(`${stats.percentage}%`);
                            $('.total-voters').text((translations.n_total_voters || '{n} total voters').replace('{n}', stats.total_voters));
                        }
                    }
                }
            });
        }

        // Initial call to update stats
        updateVoterStats();

        // Event delegation for marking a voter
        $("#voter-details").on("click", ".mark-voted", function (e) {
            e.preventDefault();
            var voterId = $(this).data("voter-id");
            var button = $(this);
            $.ajax({
                url: `{% url 'voting:mark_voted' 0 %}`.replace('0', voterId),
                type: "POST",
                headers: { "X-CSRFToken": getCSRFToken() },
                success: function (response) {
                    if (response.status === "success") {
                        var statusSpan = button.closest("#voter-details").find(".voted-status");
                        // Check current status and toggle
                        if (statusSpan.text() === (translations.voted || 'Voted')) {
                            statusSpan.text(translations.not_voted || 'Not Voted');
                            button.text(translations.mark_voted || 'Mark as Voted');
                        } else {
                            statusSpan.text(translations.voted || 'Voted');
                            button.text(translations.unmark || 'Unmark as Voted');
                        }
                        // After marking a voter, update the overall progress stats
                        updateVoterStats();
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}
